<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    /* ========================================
       DANA Task Form Base Styles v3
       ======================================== */

    /* Task Title - Above bordered container */
    .task-title {
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 20px;
        letter-spacing: -0.5px;
    }

    /* CSS Reset & Base */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    html {
        height: 100%;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: #1a1a2e;
        background-color: #f0f2f5;
        margin: 0;
        padding: 32px 16px;
        min-height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Form Container - Centered with black border */
    .form-container {
        width: 100%;
        max-width: 720px;
        margin: 0 auto;
        background: #ffffff;
        border: 2px solid #1a1a2e;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    /* Form */
    form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    /* Fieldset & Legend */
    fieldset {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin: 0 0 16px 0;
        background: #fafbfc;
    }

    legend {
        font-size: 15px;
        font-weight: 600;
        color: #2d3748;
        padding: 0 12px;
        background: #ffffff;
        border-radius: 4px;
    }

    /* Form Field */
    .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
    }

    .form-field:last-child {
        margin-bottom: 0;
    }

    /* Labels */
    label {
        font-size: 13px;
        font-weight: 500;
        color: #4a5568;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .required {
        color: #e53e3e;
        font-weight: 600;
    }

    /* Field Header (label + button row) */
    .field-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
    }

    /* Inputs & Selects */
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    input[type="datetime-local"],
    input[type="time"],
    input[type="url"],
    input[type="password"],
    select,
    textarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid #cbd5e0;
        border-radius: 6px;
        background-color: #ffffff;
        color: #1a1a2e;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }

    input:disabled,
    select:disabled,
    textarea:disabled {
        background-color: #f7fafc;
        color: #a0aec0;
        cursor: not-allowed;
    }

    input[readonly] {
        background-color: #f7fafc;
        color: #718096;
    }

    textarea {
        min-height: 80px;
        resize: vertical;
    }

    select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
    }

    /* Checkboxes & Radio */
    input[type="checkbox"],
    input[type="radio"] {
        width: 18px;
        height: 18px;
        margin: 0;
        cursor: pointer;
        accent-color: #4299e1;
    }

    .checkbox-field,
    .radio-field {
        flex-direction: row;
        align-items: center;
        gap: 10px;
    }

    .checkbox-field label,
    .radio-field label {
        font-weight: 400;
        cursor: pointer;
    }

    /* Help Text */
    .help-text,
    small {
        font-size: 12px;
        color: #718096;
        margin-top: 4px;
    }

    /* Error State */
    .form-field.error input,
    .form-field.error select,
    .form-field.error textarea {
        border-color: #e53e3e;
        background-color: #fff5f5;
    }

    .form-field.error input:focus,
    .form-field.error select:focus {
        box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.15);
    }

    .error-message {
        font-size: 12px;
        color: #e53e3e;
        margin-top: 4px;
        font-weight: 500;
    }

    /* Buttons */
    button,
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    button:disabled,
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Primary Button */
    .btn-primary,
    button[type="submit"] {
        background-color: #4299e1;
        color: #ffffff;
    }

    .btn-primary:hover,
    button[type="submit"]:hover {
        background-color: #3182ce;
    }

    /* Secondary Button */
    .btn-secondary {
        background-color: #edf2f7;
        color: #4a5568;
    }

    .btn-secondary:hover {
        background-color: #e2e8f0;
    }

    /* Add Button */
    .btn-add,
    .btn-add-row {
        background-color: #48bb78;
        color: #ffffff;
    }

    .btn-add:hover,
    .btn-add-row:hover {
        background-color: #38a169;
    }

    /* Remove/Delete Button */
    .btn-remove,
    .btn-delete {
        background-color: #fc8181;
        color: #ffffff;
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn-remove:hover,
    .btn-delete:hover {
        background-color: #f56565;
    }

    /* Link Button */
    .link-button {
        background: none;
        border: none;
        color: #4299e1;
        cursor: pointer;
        padding: 0;
        font-size: 13px;
        font-weight: 500;
        text-decoration: none;
    }

    .link-button:hover {
        color: #2b6cb0;
        text-decoration: underline;
    }

    /* Tables */
    table,
    .child-table,
    .allocation-table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 13px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }

    th {
        background-color: #f7fafc;
        font-weight: 600;
        color: #4a5568;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    tbody tr:hover {
        background-color: #f7fafc;
    }

    tbody tr:last-child td {
        border-bottom: none;
    }

    /* Table Inputs */
    table input,
    table select {
        padding: 8px 10px;
        font-size: 13px;
    }

    /* Total Row */
    .total-row,
    tfoot tr {
        background-color: #edf2f7;
        font-weight: 600;
    }

    tfoot td {
        border-bottom: none;
        border-top: 2px solid #cbd5e0;
    }

    /* Table Actions */
    .table-actions {
        margin-top: 12px;
    }

    /* Form Row (horizontal layout) */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    /* Section Headers */
    .section-header,
    h3, h4 {
        font-size: 15px;
        font-weight: 600;
        color: #2d3748;
        margin: 24px 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
    }

    h3:first-child,
    h4:first-child {
        margin-top: 0;
    }

    /* Alerts & Messages */
    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin: 12px 0;
        font-size: 13px;
    }

    .alert-info {
        background-color: #ebf8ff;
        color: #2b6cb0;
        border: 1px solid #bee3f8;
    }

    .alert-warning {
        background-color: #fffaf0;
        color: #c05621;
        border: 1px solid #fbd38d;
    }

    .alert-error {
        background-color: #fff5f5;
        color: #c53030;
        border: 1px solid #feb2b2;
    }

    .alert-success {
        background-color: #f0fff4;
        color: #276749;
        border: 1px solid #9ae6b4;
    }

    /* Two Column Layout */
    .two-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    /* Responsive */
    @media (max-width: 600px) {
        body {
            padding: 12px;
        }

        fieldset {
            padding: 16px;
        }

        .two-columns,
        .form-row {
            grid-template-columns: 1fr;
        }

        table {
            font-size: 12px;
        }

        th, td {
            padding: 8px;
        }
    }

    /* Print Styles */
    @media print {
        body {
            background: white;
            padding: 0;
        }

        .form-container {
            max-width: none;
        }

        button,
        .btn {
            display: none;
        }
    }


    /* Original Task Styles */

    

    

        .report-container {
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .filter-row {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .filter-field {
            flex: 1;
            min-width: 150px;
        }
        .filter-field label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        .filter-field select,
        .filter-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        .btn-generate {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-generate:hover {
            background: #1d4ed8;
        }
        .btn-generate:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff40;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .results-section {
            display: none;
        }
        .results-section.visible {
            display: block;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }
        .summary-card.total {
            background: #eff6ff;
            border-color: #bfdbfe;
        }
        .summary-card .label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .summary-card .value {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }
        .summary-card.total .value {
            color: #1d4ed8;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .report-table th {
            background: #f3f4f6;
            padding: 10px 12px;
            text-align: left;
            font-weight: 500;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }
        .report-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-table tr:hover {
            background: #f9fafb;
        }
        .text-right {
            text-align: right;
        }
        .amount {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }
        .aging-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .aging-current {
            background: #dcfce7;
            color: #166534;
        }
        .aging-bucket1 {
            background: #fef9c3;
            color: #854d0e;
        }
        .aging-bucket2 {
            background: #fed7aa;
            color: #9a3412;
        }
        .aging-bucket3 {
            background: #fecaca;
            color: #991b1b;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .supplier-summary {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }
        .supplier-summary h3 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <h1 class="task-title">Accounts Payable Report</h1>
    <div class="report-container">
        <!-- Filter Section -->
        <div class="filter-section">
            <form id="filterForm">
                <div class="filter-row">
                    <div class="filter-field">
                        <label for="supplier">공급처</label>
                        <select id="supplier" name="supplier">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="from_date">시작일</label>
                        <input type="date" id="from_date" name="from_date">
                    </div>
                    <div class="filter-field">
                        <label for="to_date">종료일</label>
                        <input type="date" id="to_date" name="to_date">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-field">
                        <label for="aging_based_on">연령 기준</label>
                        <select id="aging_based_on" name="aging_based_on">
                            <option value="due_date">만기일</option>
                            <option value="posting_date">송장일</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="range">연령 구간</label>
                        <select id="range" name="range">
                            <option value="30">30일</option>
                            <option value="60">60일</option>
                            <option value="90">90일</option>
                        </select>
                    </div>
                    <div class="filter-field" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn-generate" id="generateBtn">
                            <span class="btn-text">보고서 생성</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card total">
                    <div class="label">총 미지급금</div>
                    <div class="value" id="totalOutstanding">₩0</div>
                </div>
                <div class="summary-card">
                    <div class="label" id="currentLabel">0-30일</div>
                    <div class="value" id="currentAmount">₩0</div>
                </div>
                <div class="summary-card">
                    <div class="label" id="bucket1Label">31-60일</div>
                    <div class="value" id="bucket1Amount">₩0</div>
                </div>
                <div class="summary-card">
                    <div class="label" id="bucket2Label">61-90일</div>
                    <div class="value" id="bucket2Amount">₩0</div>
                </div>
                <div class="summary-card">
                    <div class="label" id="bucket3Label">90일 초과</div>
                    <div class="value" id="bucket3Amount">₩0</div>
                </div>
            </div>

            <!-- Invoice Table -->
            <table class="report-table">
                <thead>
                    <tr>
                        <th>송장번호</th>
                        <th>공급처</th>
                        <th>송장일</th>
                        <th>만기일</th>
                        <th class="text-right">송장금액</th>
                        <th class="text-right">미지급금</th>
                        <th>연체일</th>
                        <th>구간</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                </tbody>
            </table>

            <!-- No Data Message -->
            <div id="noDataMessage" class="no-data" style="display: none;">
                조회된 데이터가 없습니다.
            </div>

            <!-- Supplier Summary -->
            <div class="supplier-summary" id="supplierSummary" style="display: none;">
                <h3>공급처별 요약</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>공급처</th>
                            <th class="text-right">송장 수</th>
                            <th class="text-right">미지급 합계</th>
                        </tr>
                    </thead>
                    <tbody id="supplierSummaryBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let formInitialized = false;

        // Format currency
        function formatCurrency(amount) {
            return '₩' + new Intl.NumberFormat('ko-KR').format(Math.round(amount));
        }

        // Get aging badge class
        function getAgingBadgeClass(bucket) {
            if (bucket.includes('미도래') || bucket.startsWith('0-')) return 'aging-current';
            if (bucket.includes('31-') || bucket.includes('61-')) return 'aging-bucket1';
            if (bucket.includes('61-') || bucket.includes('91-')) return 'aging-bucket2';
            if (bucket.includes('초과')) return 'aging-bucket3';
            return 'aging-current';
        }

        // Initialize form with fetch data
        function initializeForm(options, defaults) {
            if (formInitialized) return;
            formInitialized = true;

            // Populate supplier dropdown
            if (options.supplier && options.supplier.length > 0) {
                const supplierSelect = document.getElementById('supplier');
                supplierSelect.innerHTML = '<option value="">전체</option>';
                options.supplier.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    supplierSelect.appendChild(option);
                });
            }

            // Populate aging_based_on dropdown
            if (options.aging_based_on && options.aging_based_on.length > 0) {
                const agingSelect = document.getElementById('aging_based_on');
                agingSelect.innerHTML = '';
                options.aging_based_on.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    agingSelect.appendChild(option);
                });
            }

            // Populate range dropdown
            if (options.range && options.range.length > 0) {
                const rangeSelect = document.getElementById('range');
                rangeSelect.innerHTML = '';
                options.range.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    rangeSelect.appendChild(option);
                });
            }

            // Set defaults
            if (defaults.to_date) {
                document.getElementById('to_date').value = defaults.to_date;
            }
            if (defaults.aging_based_on) {
                document.getElementById('aging_based_on').value = defaults.aging_based_on;
            }
            if (defaults.range) {
                document.getElementById('range').value = defaults.range;
            }
        }

        // Render report results
        function renderReport(data) {
            const resultsSection = document.getElementById('resultsSection');
            const reportTableBody = document.getElementById('reportTableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            const supplierSummary = document.getElementById('supplierSummary');
            const supplierSummaryBody = document.getElementById('supplierSummaryBody');

            resultsSection.classList.add('visible');

            // Update summary cards
            const totals = data.totals || {};
            const buckets = data.aging_buckets || {};

            document.getElementById('totalOutstanding').textContent = formatCurrency(totals.total_outstanding || 0);
            document.getElementById('currentAmount').textContent = formatCurrency(totals.current || 0);
            document.getElementById('bucket1Amount').textContent = formatCurrency(totals.bucket_1 || 0);
            document.getElementById('bucket2Amount').textContent = formatCurrency(totals.bucket_2 || 0);
            document.getElementById('bucket3Amount').textContent = formatCurrency(totals.bucket_3 || 0);

            // Update bucket labels
            if (buckets.current) document.getElementById('currentLabel').textContent = buckets.current;
            if (buckets.bucket_1) document.getElementById('bucket1Label').textContent = buckets.bucket_1;
            if (buckets.bucket_2) document.getElementById('bucket2Label').textContent = buckets.bucket_2;
            if (buckets.bucket_3) document.getElementById('bucket3Label').textContent = buckets.bucket_3;

            // Render invoice table
            const reportData = data.report_data || [];
            if (reportData.length === 0) {
                reportTableBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                supplierSummary.style.display = 'none';
                return;
            }

            noDataMessage.style.display = 'none';
            reportTableBody.innerHTML = reportData.map(row => `
                <tr>
                    <td>${row.invoice}</td>
                    <td>${row.supplier_name}</td>
                    <td>${row.posting_date}</td>
                    <td>${row.due_date || '-'}</td>
                    <td class="text-right amount">${formatCurrency(row.grand_total)}</td>
                    <td class="text-right amount">${formatCurrency(row.outstanding_amount)}</td>
                    <td class="text-right">${row.days_overdue}일</td>
                    <td><span class="aging-badge ${getAgingBadgeClass(row.aging_bucket)}">${row.aging_bucket}</span></td>
                </tr>
            `).join('');

            // Render supplier summary
            const supplierData = data.supplier_summary || [];
            if (supplierData.length > 0) {
                supplierSummary.style.display = 'block';
                supplierSummaryBody.innerHTML = supplierData.map(row => `
                    <tr>
                        <td>${row.supplier_name}</td>
                        <td class="text-right">${row.invoice_count}</td>
                        <td class="text-right amount">${formatCurrency(row.total_outstanding)}</td>
                    </tr>
                `).join('');
            }
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Hide error
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Set loading state
        function setLoading(loading) {
            const btn = document.getElementById('generateBtn');
            const btnText = btn.querySelector('.btn-text');

            if (loading) {
                btn.disabled = true;
                btnText.innerHTML = '<span class="spinner"></span> 조회 중...';
            } else {
                btn.disabled = false;
                btnText.textContent = '보고서 생성';
            }
        }

        // Get form data
        function getFormData() {
            const form = document.getElementById('filterForm');
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (value) data[key] = value;
            }
            return data;
        }

        // Pending API request tracking
        let pendingApiRequest = null;

        // Generate report via parent postMessage (using fetch endpoint)
        async function generateReport() {
            hideError();
            setLoading(true);

            const formData = getFormData();
            formData.generate_report = true;  // Flag to include report data in fetch response
            const requestId = 'fetch-' + Date.now();

            // Store the request ID to match with response
            pendingApiRequest = requestId;

            // Send fetch request to parent with generate_report flag
            // Parent will use fetch_endpoint from task metadata
            window.parent.postMessage({
                type: 'TASK_IFRAME_FETCH_DATA',
                taskIndex: window.TASK_INDEX || 0,
                taskId: window.TASK_ID || '',
                tabId: window.TAB_ID || '',
                requestId: requestId,
                payload: formData,
            }, '*');
        }

        // Handle fetch response from parent
        function handleFetchResponse(data) {
            if (data.requestId !== pendingApiRequest) return;
            pendingApiRequest = null;
            setLoading(false);

            if (data.success) {
                const responseData = data.data?.data || data.data || {};
                // If report_data exists, render the report
                if (responseData.report_data) {
                    renderReport(responseData);
                }
            } else {
                showError(data.error || '보고서 생성 중 오류가 발생했습니다.');
            }
        }

        // Form submit handler
        document.getElementById('filterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await generateReport();
        });

        // Set task input (pre-populate form)
        function setTaskInput(data) {
            if (!data) return;

            const options = data.data?.options || data.options || {};
            const defaults = data.data?.defaults || data.defaults || {};

            if (Object.keys(options).length > 0) {
                initializeForm(options, defaults);
                return;
            }

            // Populate form fields (for restore/edit mode)
            Object.keys(data).forEach(key => {
                const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = data[key];
                }
            });
        }

        // Get task input
        function getTaskInput() {
            return getFormData();
        }

        // Validate task input
        function validateTaskInput() {
            return true; // No required fields for this report
        }

        // Listen for messages from parent
        window.addEventListener('message', (event) => {
            if (event.data.type === 'taskData') {
                setTaskInput(event.data.data);
            }
            if (event.data.type === 'fetchResponse') {
                const options = event.data.data?.data?.options || event.data.data?.options || {};
                const defaults = event.data.data?.data?.defaults || event.data.data?.defaults || {};
                initializeForm(options, defaults);
            }
            if (event.data.type === 'TASK_FETCH_RESPONSE') {
                handleFetchResponse(event.data);
            }
        });

        // Expose functions for external access
        window.getTaskInput = getTaskInput;
        window.setTaskInput = setTaskInput;
        window.validateTaskInput = validateTaskInput;
        window.initializeForm = initializeForm;
    </script>
</body>
</html>
