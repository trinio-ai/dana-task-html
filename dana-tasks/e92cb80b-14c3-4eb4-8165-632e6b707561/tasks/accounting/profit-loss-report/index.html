<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .filters { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .report-section { margin: 20px 0; }
        .section-header { font-weight: bold; font-size: 1.1em; background: #e7f3ff; padding: 10px; margin-bottom: 5px; }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .report-table td:last-child { text-align: right; }
        .indent-1 { padding-left: 20px !important; }
        .indent-2 { padding-left: 40px !important; }
        .total-row { font-weight: bold; border-top: 2px solid #333; }
        .subtotal-row { font-weight: bold; background: #f5f5f5; }
        .profit { color: #28a745; }
        .loss { color: #dc3545; }
        .net-result { font-size: 1.2em; padding: 15px; margin-top: 20px; border-radius: 8px; }
        .net-profit { background: #d4edda; border: 1px solid #28a745; }
        .net-loss { background: #f8d7da; border: 1px solid #dc3545; }
    </style>
</head>
<body>
    <div class="form-container">
        <form id="taskForm">
            <div class="filters">
                <div class="form-row">
                    <div class="form-field">
                        <label for="company">Company <span class="required">*</span></label>
                        <select id="company" name="company" required data-fetch-endpoint="/api/erp/companies" onchange="loadReport()">
                            <option value="">Select Company</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="fiscal_year">Fiscal Year</label>
                        <select id="fiscal_year" name="fiscal_year" data-fetch-endpoint="/api/erp/fiscal-years" onchange="setFiscalYearDates()">
                            <option value="">Select Fiscal Year</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label for="from_date">From Date <span class="required">*</span></label>
                        <input type="date" id="from_date" name="from_date" required onchange="loadReport()">
                    </div>

                    <div class="form-field">
                        <label for="to_date">To Date <span class="required">*</span></label>
                        <input type="date" id="to_date" name="to_date" required onchange="loadReport()">
                    </div>

                    <div class="form-field">
                        <label for="periodicity">Periodicity</label>
                        <select id="periodicity" name="periodicity" onchange="loadReport()">
                            <option value="Yearly">Yearly</option>
                            <option value="Half-Yearly">Half-Yearly</option>
                            <option value="Quarterly">Quarterly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label for="cost_center">Cost Center</label>
                        <select id="cost_center" name="cost_center" data-fetch-endpoint="/api/erp/cost-centers" onchange="loadReport()">
                            <option value="">All Cost Centers</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="project">Project</label>
                        <select id="project" name="project" data-fetch-endpoint="/api/erp/projects" onchange="loadReport()">
                            <option value="">All Projects</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <div class="section-header">Income</div>
                <table class="report-table" id="incomeTable">
                    <tbody id="incomeBody">
                        <tr><td colspan="2">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="report-section">
                <div class="section-header">Expenses</div>
                <table class="report-table" id="expenseTable">
                    <tbody id="expenseBody">
                        <tr><td colspan="2">No data loaded</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="netResult" class="net-result" style="display: none;">
                <span id="netResultLabel">Net Profit</span>: <strong id="netResultAmount">0.00</strong>
            </div>
        </form>
    </div>

    <script>
        // Set default dates to current fiscal year
        const today = new Date();
        const fiscalYearStart = new Date(today.getFullYear(), 0, 1);
        document.getElementById('from_date').valueAsDate = fiscalYearStart;
        document.getElementById('to_date').valueAsDate = today;

        function setFiscalYearDates() {
            // If fiscal year selected, update date range
            const msg = {
                type: 'fetchData',
                endpoint: '/api/v1/erp/fiscal-years/' + document.getElementById('fiscal_year').value
            };
            window.parent.postMessage(msg, '*');
        }

        function loadReport() {
            const company = document.getElementById('company').value;
            const fromDate = document.getElementById('from_date').value;
            const toDate = document.getElementById('to_date').value;

            if (!company || !fromDate || !toDate) return;

            const msg = {
                type: 'fetchData',
                endpoint: '/api/v1/erp/accounting/profit-loss',
                filters: getTaskInput()
            };
            window.parent.postMessage(msg, '*');
        }

        function renderAccounts(containerId, accounts, isIncome = true) {
            const tbody = document.getElementById(containerId);
            if (!accounts || accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2">No entries</td></tr>';
                return 0;
            }

            let total = 0;
            tbody.innerHTML = accounts.map(acc => {
                total += acc.amount || 0;
                const indentClass = acc.indent ? `indent-${acc.indent}` : '';
                const rowClass = acc.is_group ? 'subtotal-row' : '';
                return `
                    <tr class="${rowClass}">
                        <td class="${indentClass}">${acc.account_name || acc.account}</td>
                        <td>${(acc.amount || 0).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            // Add total row
            tbody.innerHTML += `
                <tr class="total-row">
                    <td>Total ${isIncome ? 'Income' : 'Expenses'}</td>
                    <td>${total.toFixed(2)}</td>
                </tr>
            `;

            return total;
        }

        function getTaskInput() {
            return {
                company: document.getElementById('company').value,
                fiscal_year: document.getElementById('fiscal_year').value || null,
                from_date: document.getElementById('from_date').value,
                to_date: document.getElementById('to_date').value,
                cost_center: document.getElementById('cost_center').value || null,
                project: document.getElementById('project').value || null,
                periodicity: document.getElementById('periodicity').value,
                include_default_book_entries: true
            };
        }

        function validateForm() {
            const data = getTaskInput();
            if (!data.company) { alert('Please select company'); return false; }
            if (!data.from_date) { alert('Please select from date'); return false; }
            if (!data.to_date) { alert('Please select to date'); return false; }
            return true;
        }

        function setTaskInput(data) {
            if (!data) return;

            const totalIncome = renderAccounts('incomeBody', data.income, true);
            const totalExpense = renderAccounts('expenseBody', data.expense, false);

            const netProfitLoss = totalIncome - totalExpense;
            const netResultDiv = document.getElementById('netResult');
            const netResultLabel = document.getElementById('netResultLabel');
            const netResultAmount = document.getElementById('netResultAmount');

            netResultDiv.style.display = 'block';
            if (netProfitLoss >= 0) {
                netResultDiv.className = 'net-result net-profit';
                netResultLabel.textContent = 'Net Profit';
                netResultAmount.textContent = netProfitLoss.toFixed(2);
            } else {
                netResultDiv.className = 'net-result net-loss';
                netResultLabel.textContent = 'Net Loss';
                netResultAmount.textContent = Math.abs(netProfitLoss).toFixed(2);
            }
        }

        window.addEventListener('message', (e) => { if (e.data.type === 'taskData') setTaskInput(e.data.data); });
        window.getTaskInput = getTaskInput;
        window.setTaskInput = setTaskInput;
        window.validateTaskInput = validateForm;
    </script>
</body>
</html>
