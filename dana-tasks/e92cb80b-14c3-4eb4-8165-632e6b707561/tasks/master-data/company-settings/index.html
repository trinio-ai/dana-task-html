<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../dependency-helper.js"></script>
</head>
<body>
    <div class="form-container">
        <form id="taskForm">
            <div class="form-field">
                <label for="company">Company <span class="required">*</span></label>
                <select id="company" name="company" required data-dependency-task="company-create" data-dependency-label="+ New Company">
                    <option value="">Select company</option>
                </select>
            </div>

            <div class="form-field">
                <label for="fiscal_year_start">Fiscal Year Start Month <span class="required">*</span></label>
                <select id="fiscal_year_start" name="fiscal_year_start" required>
                    <option value="">Select month</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>

            <div class="form-field">
                <label for="default_payment_terms">Default Payment Terms (Days) <span class="required">*</span></label>
                <input type="number" id="default_payment_terms" name="default_payment_terms" min="0" max="365" value="30" required>
            </div>

            <div class="form-field">
                <label for="tax_id">Tax Identification Number</label>
                <input type="text" id="tax_id" name="tax_id" placeholder="e.g., 123-45-67890">
            </div>

            <div class="form-field">
                <label for="sales_invoice_series">Sales Invoice Series Prefix</label>
                <input type="text" id="sales_invoice_series" name="sales_invoice_series" placeholder="e.g., SINV-" maxlength="10">
            </div>

            <div class="form-field">
                <label for="purchase_invoice_series">Purchase Invoice Series Prefix</label>
                <input type="text" id="purchase_invoice_series" name="purchase_invoice_series" placeholder="e.g., PINV-" maxlength="10">
            </div>

            <div class="form-field">
                <label for="stock_entry_series">Stock Entry Series Prefix</label>
                <input type="text" id="stock_entry_series" name="stock_entry_series" placeholder="e.g., STE-" maxlength="10">
            </div>

            <div class="form-field">
                <label for="date_format">Date Format <span class="required">*</span></label>
                <select id="date_format" name="date_format" required>
                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                    <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                </select>
            </div>

            <div class="form-field">
                <label for="time_zone">Time Zone <span class="required">*</span></label>
                <select id="time_zone" name="time_zone" required>
                    <option value="Asia/Seoul">Asia/Seoul (KST)</option>
                    <option value="UTC">UTC</option>
                    <option value="America/New_York">America/New_York (EST)</option>
                    <option value="Europe/London">Europe/London (GMT)</option>
                </select>
            </div>
        </form>
    </div>

    <script>
        function getTaskInput() {
            const formData = new FormData(document.getElementById('taskForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            return data;
        }

        function validateTaskInput() {
            const errors = [];
            const form = document.getElementById('taskForm');

            form.querySelectorAll('[required]').forEach(input => {
                if (!input.value) {
                    errors.push(`${input.previousElementSibling.textContent.replace(' *', '')} is required`);
                }
            });

            const paymentTerms = parseInt(document.getElementById('default_payment_terms').value);
            if (paymentTerms < 0 || paymentTerms > 365) {
                errors.push('Payment terms must be between 0 and 365 days');
            }

            return { valid: errors.length === 0, errors };
        }

        function setTaskInput(data) {
            if (!data) return;
            const options = data.options || data.data?.options || {};
            const defaults = data.defaults || data.data?.defaults || {};

            if (options.company) {
                const select = document.getElementById('company');
                select.innerHTML = '<option value="">' + 'Select company' + '</option>' + options.company.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            }
            if (options.fiscal_year_start) {
                const select = document.getElementById('fiscal_year_start');
                select.innerHTML = '<option value="">' + 'Select month' + '</option>' + options.fiscal_year_start.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            }
            if (options.date_format) {
                const select = document.getElementById('date_format');
                select.innerHTML = options.date_format.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            }
            if (options.time_zone) {
                const select = document.getElementById('time_zone');
                select.innerHTML = options.time_zone.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            }

            Object.keys(data).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    input.value = data[key];
                }
            });

            if (defaults.company) document.getElementById('company').value = defaults.company;
            if (defaults.fiscal_year_start) document.getElementById('fiscal_year_start').value = defaults.fiscal_year_start;
            if (defaults.date_format) document.getElementById('date_format').value = defaults.date_format;
            if (defaults.time_zone) document.getElementById('time_zone').value = defaults.time_zone;
        }

        window.getTaskInput = getTaskInput;
        window.setTaskInput = setTaskInput;
        window.validateTaskInput = validateTaskInput;
    </script>
</body>
</html>
