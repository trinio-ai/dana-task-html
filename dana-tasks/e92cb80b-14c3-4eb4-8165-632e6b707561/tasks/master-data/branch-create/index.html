<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../dependency-helper.js"></script>
</head>
<body>
    <div class="form-container">
        <form id="taskForm">
            <div class="form-field">
                <div class="field-header">
                    <label for="company">Company <span class="required">*</span></label>
                    <button type="button" class="link-button" onclick="openDependencyTask('company-create')">+ New Company</button>
                </div>
                <select id="company" name="company" required data-dependency-task="company-create" data-dependency-label="+ New Company">
                    <option value="">Select company</option>
                </select>
            </div>

            <div class="form-field">
                <label for="branch_name">Branch/Department Name <span class="required">*</span></label>
                <input type="text" id="branch_name" name="branch_name" required placeholder="e.g., Seoul Office, Sales Department">
            </div>

            <div class="form-field">
                <label for="branch_code">Branch Code <span class="required">*</span></label>
                <input type="text" id="branch_code" name="branch_code" required maxlength="10" placeholder="e.g., SEO, SALES">
            </div>

            <div class="form-field">
                <label for="branch_type">Branch Type <span class="required">*</span></label>
                <select id="branch_type" name="branch_type" required>
                    <option value="">Select type</option>
                    <option value="branch">Branch Office</option>
                    <option value="department">Department</option>
                    <option value="cost_center">Cost Center</option>
                    <option value="warehouse">Warehouse Location</option>
                </select>
            </div>

            <div class="form-field">
                <label for="parent_branch">Parent Branch</label>
                <select id="parent_branch" name="parent_branch">
                    <option value="">None (Top Level)</option>
                </select>
            </div>

            <div class="form-field">
                <label for="manager_name">Manager Name</label>
                <input type="text" id="manager_name" name="manager_name">
            </div>

            <div class="form-field">
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="3"></textarea>
            </div>

            <div class="form-field">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone">
            </div>

            <div class="form-field">
                <label for="email">Email</label>
                <input type="email" id="email" name="email">
            </div>

            <div class="form-field">
                <label class="checkbox-label">
                    <input type="checkbox" id="is_active" name="is_active" checked>
                    <span>Active</span>
                </label>
            </div>
        </form>
    </div>

    <script>
        function getTaskInput() {
            const formData = new FormData(document.getElementById('taskForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            data.is_active = document.getElementById('is_active').checked;
            return data;
        }

        function validateTaskInput() {
            const errors = [];
            const form = document.getElementById('taskForm');

            form.querySelectorAll('[required]').forEach(input => {
                if (!input.value) {
                    errors.push(`${input.previousElementSibling.textContent.replace(' *', '')} is required`);
                }
            });

            const branchCode = document.getElementById('branch_code').value;
            if (branchCode && branchCode.length > 10) {
                errors.push('Branch code must be 10 characters or less');
            }

            return { valid: errors.length === 0, errors };
        }

        function setTaskInput(data) {
            if (!data) return;

            const options = data.options || data.data?.options || {};
            if (options.company) {
                const select = document.getElementById('company');
                select.innerHTML = '<option value="">Select company</option>' + options.company.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            }
            if (options.parent_branch) {
                const select = document.getElementById('parent_branch');
                select.innerHTML = '<option value="">None (Top Level)</option>' + options.parent_branch.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
            }

            Object.keys(data).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = !!data[key];
                    } else {
                        input.value = data[key];
                    }
                }
            });
        }

        window.getTaskInput = getTaskInput;
        window.setTaskInput = setTaskInput;
        window.validateTaskInput = validateTaskInput;
    </script>
</body>
</html>
