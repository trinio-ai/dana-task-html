<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .invoice-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef; }
        .receipt-list { margin: 15px 0; }
        .receipt-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .receipt-card.selected { border-color: #28a745; background: #e8f5e9; }
        .match-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .match-table th, .match-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .match-table th { background: #f5f5f5; }
        .match-status { padding: 5px 10px; border-radius: 4px; font-weight: bold; }
        .match-status.matched { background: #d4edda; color: #155724; }
        .match-status.partial { background: #fff3cd; color: #856404; }
        .match-status.unmatched { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="form-container">
        <form id="taskForm">
            <div class="form-field">
                <label for="purchase_invoice">Purchase Invoice <span class="required">*</span></label>
                <select id="purchase_invoice" name="purchase_invoice" required data-fetch-endpoint="/api/erp/purchase-invoices?docstatus=0">
                    <option value="">Select Invoice to Match</option>
                </select>
            </div>

            <div id="invoiceInfo" class="invoice-info" style="display: none;">
                <h4>Invoice Details</h4>
                <div class="info-row">
                    <span>Supplier:</span>
                    <span id="supplier">-</span>
                </div>
                <div class="info-row">
                    <span>Invoice Total:</span>
                    <span id="grand_total">0.00</span>
                </div>
            </div>

            <h4>Available Receipts</h4>
            <div id="receiptList" class="receipt-list">
                <p>Select an invoice to see available receipts</p>
            </div>

            <h4>Matching Summary</h4>
            <table class="match-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Invoice Qty</th>
                        <th>Receipt Qty</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="matchSummary">
                    <tr><td colspan="4">Select items to see matching summary</td></tr>
                </tbody>
            </table>
        </form>
    </div>

    <script>
        let invoiceItems = [];
        let selectedReceipts = {};

        function updateMatchSummary() {
            const tbody = document.getElementById('matchSummary');
            tbody.innerHTML = '';

            invoiceItems.forEach(item => {
                let receiptQty = 0;
                Object.values(selectedReceipts).forEach(receipt => {
                    const matchedItem = receipt.items.find(i => i.item_code === item.item_code);
                    if (matchedItem) receiptQty += matchedItem.qty || 0;
                });

                const status = receiptQty >= item.qty ? 'matched' : receiptQty > 0 ? 'partial' : 'unmatched';
                const statusText = receiptQty >= item.qty ? 'Matched' : receiptQty > 0 ? 'Partial' : 'Unmatched';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.item_name || item.item_code}</td>
                    <td>${item.qty}</td>
                    <td>${receiptQty}</td>
                    <td><span class="match-status ${status}">${statusText}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleReceipt(receiptName, receiptData) {
            if (selectedReceipts[receiptName]) {
                delete selectedReceipts[receiptName];
            } else {
                selectedReceipts[receiptName] = receiptData;
            }
            document.querySelectorAll('.receipt-card').forEach(card => {
                card.classList.toggle('selected', !!selectedReceipts[card.dataset.receipt]);
            });
            updateMatchSummary();
        }

        function getTaskInput() {
            return {
                purchase_invoice: document.getElementById('purchase_invoice').value,
                purchase_receipts: Object.entries(selectedReceipts).map(([name, data]) => ({
                    purchase_receipt: name,
                    items: data.items
                }))
            };
        }

        function validateForm() {
            if (!document.getElementById('purchase_invoice').value) {
                alert('Please select an invoice');
                return false;
            }
            if (Object.keys(selectedReceipts).length === 0) {
                alert('Please select at least one receipt');
                return false;
            }
            return true;
        }

        function setTaskInput(data) {
            if (!data) return;
            if (data.purchase_invoice) document.getElementById('purchase_invoice').value = data.purchase_invoice;
            if (data.supplier) {
                document.getElementById('supplier').textContent = data.supplier_name || data.supplier;
                document.getElementById('grand_total').textContent = (data.grand_total || 0).toFixed(2);
                invoiceItems = data.items || [];
                document.getElementById('invoiceInfo').style.display = 'block';

                // Render available receipts
                const receiptList = document.getElementById('receiptList');
                if (data.available_receipts && data.available_receipts.length > 0) {
                    receiptList.innerHTML = '';
                    data.available_receipts.forEach(receipt => {
                        const card = document.createElement('div');
                        card.className = 'receipt-card';
                        card.dataset.receipt = receipt.name;
                        card.innerHTML = `
                            <label>
                                <input type="checkbox" onchange="toggleReceipt('${receipt.name}', ${JSON.stringify(receipt).replace(/"/g, '&quot;')})">
                                <strong>${receipt.name}</strong> - ${receipt.posting_date}
                                <br><small>Items: ${receipt.items.map(i => `${i.item_code} (${i.qty})`).join(', ')}</small>
                            </label>
                        `;
                        receiptList.appendChild(card);
                    });
                } else {
                    receiptList.innerHTML = '<p>No unmatched receipts found for this supplier</p>';
                }

                updateMatchSummary();
            }
        }

        window.addEventListener('message', (e) => { if (e.data.type === 'taskData') setTaskInput(e.data.data); });
        window.getTaskInput = getTaskInput;
        window.setTaskInput = setTaskInput;
        window.validateTaskInput = validateForm;
    </script>
</body>
</html>
