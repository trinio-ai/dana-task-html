<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .form-field { margin-bottom: 15px; }
        .form-field label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-field input, .form-field select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .required { color: red; }
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
        .items-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .items-table th, .items-table td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        .items-table th { background: #f5f5f5; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-add { background: #007bff; color: white; }
        .btn-remove { background: #dc3545; color: white; padding: 4px 8px; }
    </style>
</head>
<body>
    <div class="form-container">
        <form id="taskForm">
            <div class="row">
                <div class="col">
                    <div class="form-field">
                        <label for="from_warehouse">From Warehouse <span class="required">*</span></label>
                        <select id="from_warehouse" name="from_warehouse" required
                                data-fetch-endpoint="/api/erp/warehouses">
                            <option value="">Select Source</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-field">
                        <label for="to_warehouse">To Warehouse <span class="required">*</span></label>
                        <select id="to_warehouse" name="to_warehouse" required
                                data-fetch-endpoint="/api/erp/warehouses">
                            <option value="">Select Destination</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-field">
                        <label for="schedule_date">Schedule Date</label>
                        <input type="date" id="schedule_date" name="schedule_date">
                    </div>
                </div>
            </div>

            <div class="form-field">
                <label>Items to Transfer <span class="required">*</span></label>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody"></tbody>
                </table>
                <button type="button" class="btn btn-add" onclick="addRow()" style="margin-top:10px;">Add Item</button>
            </div>
        </form>
    </div>

    <script>
        let itemOptions = [];

        function addRow() {
            const tbody = document.getElementById('itemsBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select class="item-select" required>
                        <option value="">Select Item</option>
                        ${itemOptions.map(i => `<option value="${i.value}">${i.label}</option>`).join('')}
                    </select>
                </td>
                <td><input type="number" class="qty-input" value="1" min="1" required style="width:100px;"></td>
                <td><button type="button" class="btn btn-remove" onclick="this.closest('tr').remove()">X</button></td>
            `;
            tbody.appendChild(row);
        }

        function getTaskInput() {
            const items = [];
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                const itemCode = row.querySelector('.item-select')?.value;
                const qty = parseFloat(row.querySelector('.qty-input')?.value || 0);
                if (itemCode && qty > 0) {
                    items.push({ item_code: itemCode, qty: qty });
                }
            });

            return {
                stock_entry_type: 'Material Transfer',
                from_warehouse: document.getElementById('from_warehouse').value,
                to_warehouse: document.getElementById('to_warehouse').value,
                schedule_date: document.getElementById('schedule_date').value || null,
                items: items
            };
        }

        function validateForm() {
            if (!document.getElementById('from_warehouse').value) {
                alert('Please select source warehouse');
                return false;
            }
            if (!document.getElementById('to_warehouse').value) {
                alert('Please select destination warehouse');
                return false;
            }
            if (document.getElementById('from_warehouse').value === document.getElementById('to_warehouse').value) {
                alert('Source and destination warehouses must be different');
                return false;
            }
            if (document.querySelectorAll('#itemsBody tr').length === 0) {
                alert('Please add at least one item');
                return false;
            }
            return true;
        }

        function setTaskInput(data) {
            if (!data) return;
            if (data.options?.item_code) {
                itemOptions = data.options.item_code;
            }
            if (data.options?.warehouse) {
                const fromSelect = document.getElementById('from_warehouse');
                const toSelect = document.getElementById('to_warehouse');
                const opts = data.options.warehouse.map(w =>
                    `<option value="${w.value}">${w.label}</option>`
                ).join('');
                fromSelect.innerHTML = '<option value="">Select Source</option>' + opts;
                toSelect.innerHTML = '<option value="">Select Destination</option>' + opts;
            }
            // Add initial row
            if (document.querySelectorAll('#itemsBody tr').length === 0) {
                addRow();
            }
        }

        window.addEventListener('message', (e) => { if (e.data.type === 'taskData') setTaskInput(e.data.data); });
        window.getTaskInput = getTaskInput;
        window.setTaskInput = setTaskInput;
        window.validateTaskInput = validateForm;
    </script>
</body>
</html>
