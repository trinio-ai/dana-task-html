<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .form-field { margin-bottom: 15px; }
        .form-field label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-field input, .form-field select, .form-field textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .required { color: red; }
        .order-summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0; }
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .summary-label { color: #666; }
        .summary-value { font-weight: bold; }
        .status-complete { color: #28a745; }
        .status-partial { color: #ffc107; }
        .status-pending { color: #dc3545; }
        .info-box { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .info-success { background: #d4edda; border: 1px solid #c3e6cb; }
        .info-warning { background: #fff3cd; border: 1px solid #ffc107; }
    </style>
</head>
<body>
    <div class="form-container">
        <form id="taskForm">
            <div class="form-field">
                <label for="sales_order">Select Sales Order to Close <span class="required">*</span></label>
                <select id="sales_order" name="sales_order" required onchange="loadSalesOrder()"
                        data-fetch-endpoint="/api/erp/selling/sales-orders?docstatus=1&status=To Deliver and Bill,To Bill,To Deliver">
                    <option value="">Select Sales Order</option>
                </select>
            </div>

            <div class="order-summary" id="orderSummary" style="display: none;">
                <h4>Order Summary</h4>
                <div class="summary-row">
                    <span class="summary-label">Customer:</span>
                    <span class="summary-value" id="summary_customer">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Order Date:</span>
                    <span class="summary-value" id="summary_date">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Grand Total:</span>
                    <span class="summary-value" id="summary_total">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Delivery Status:</span>
                    <span class="summary-value" id="summary_delivered">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Billing Status:</span>
                    <span class="summary-value" id="summary_billed">-</span>
                </div>
            </div>

            <div class="info-box" id="statusInfo" style="display: none;"></div>

            <div class="form-field">
                <label for="reason">Reason for Closing (optional)</label>
                <textarea id="reason" name="reason" rows="3" placeholder="Optionally provide a reason for closing this order..."></textarea>
            </div>
        </form>
    </div>

    <script>
        function loadSalesOrder() {
            const salesOrder = document.getElementById('sales_order').value;
            if (!salesOrder) {
                document.getElementById('orderSummary').style.display = 'none';
                document.getElementById('statusInfo').style.display = 'none';
                return;
            }
            const msg = { type: 'fetchData', endpoint: `/api/v1/erp/selling/sales-orders/${salesOrder}` };
            window.parent.postMessage(msg, '*');
        }

        function getStatusClass(percent) {
            if (percent >= 100) return 'status-complete';
            if (percent > 0) return 'status-partial';
            return 'status-pending';
        }

        function renderOrder(data) {
            document.getElementById('summary_customer').textContent = data.customer_name || data.customer || '-';
            document.getElementById('summary_date').textContent = data.transaction_date || '-';
            document.getElementById('summary_total').textContent = (data.grand_total || 0).toLocaleString('ko-KR', {minimumFractionDigits: 2});

            const delivered = data.per_delivered || 0;
            const billed = data.per_billed || 0;

            const deliveredSpan = document.getElementById('summary_delivered');
            deliveredSpan.textContent = delivered.toFixed(1) + '% delivered';
            deliveredSpan.className = 'summary-value ' + getStatusClass(delivered);

            const billedSpan = document.getElementById('summary_billed');
            billedSpan.textContent = billed.toFixed(1) + '% billed';
            billedSpan.className = 'summary-value ' + getStatusClass(billed);

            document.getElementById('orderSummary').style.display = 'block';

            // Show appropriate info box
            const statusInfo = document.getElementById('statusInfo');
            if (delivered >= 100 && billed >= 100) {
                statusInfo.className = 'info-box info-success';
                statusInfo.innerHTML = '<strong>Order Complete</strong><br>This order is fully delivered and billed. Closing will mark it as complete.';
            } else {
                statusInfo.className = 'info-box info-warning';
                statusInfo.innerHTML = '<strong>Partial Completion</strong><br>This order has not been fully delivered/billed. Closing will stop further transactions against this order.';
            }
            statusInfo.style.display = 'block';
        }

        function getTaskInput() {
            return {
                sales_order: document.getElementById('sales_order').value,
                reason: document.getElementById('reason').value || null
            };
        }

        function validateForm() {
            if (!document.getElementById('sales_order').value) {
                alert('Please select a sales order');
                return false;
            }
            return true;
        }

        function setTaskInput(data) {
            if (!data) return;
            if (data.sales_order || data.name) {
                renderOrder(data);
            } else if (Array.isArray(data) || data.data) {
                const items = Array.isArray(data) ? data : data.data;
                const select = document.getElementById('sales_order');
                select.innerHTML = '<option value="">Select Sales Order</option>' +
                    items.map(o => `<option value="${o.name}">${o.label || o.name}</option>`).join('');
            }
        }

        window.addEventListener('message', (e) => { if (e.data.type === 'taskData') setTaskInput(e.data.data); });
        window.getTaskInput = getTaskInput;
        window.setTaskInput = setTaskInput;
        window.validateTaskInput = validateForm;
    </script>
</body>
</html>
